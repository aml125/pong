
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta charset="UTF-8"> 
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style>
</head>
<body onload="startGame()">
<script>

var jugador1;
var jugador2;
var pelota;
var contadorj1;
var contadorj2;
var pelInitPosX;
var pelInitPosY;
var pelInitVelX;
var pelInitVelY;
var pelMaxVelX;
var pelMaxVelY;
var p1;
var p2;
var centro;
var iabool;
var aumentoVel;
var wait;
var timeSaved;
var invervalID;
var incrementoVel = 0.2;

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 800;
        this.canvas.height = 600;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 10);
        },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

function startGame() {
	timeSaved = new Date().getTime() / 1000
	wait = true;
	invervalID = setInterval(stopWaiting, 5000);
	myGameArea.start();
	iabool = false;
	p1 = 0;
	p2 = 0;
	aumentoVel = 0;
    jugador1 = new component(15, 60, "red", 10, myGameArea.canvas.height/2-60);
	jugador2 = new component(15, 60, "blue", myGameArea.canvas.width-10-15, myGameArea.canvas.height/2-60);
	pelInitPosX = myGameArea.canvas.width/2 - 2.5;
	pelInitPosY = myGameArea.canvas.height/2 - 20;
	pelInitVelX = 5;
	pelInitVelY = 0;
	pelMaxVelX = 10;
	pelMaxVelY = 20;
	pelota = new component(10, 10, "green", pelInitPosX, pelInitPosY);
	pelota.speedX = pelInitVelX;
	pelota.speedY = pelInitVelY;
	contadorj1 = new component("30px", "Consolas", "black", myGameArea.canvas.width/2-20-30, 40, "text");
	contadorj1.text = "" + p1;
	contadorj2 = new component("30px", "Consolas", "black", myGameArea.canvas.width/2+20, 40, "text");
	contadorj2.text = "" + p2;
	centro = new component(5, 768, "black", myGameArea.canvas.width/2, 0);
	document.addEventListener("keydown", keyDownHandler, false);
	document.addEventListener("keyup", keyUpHandler, false);
}

function component(width, height, color, x, y, type) {
    this.type = type;
    this.score = 0;
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;    
    this.x = x;
    this.y = y;
    this.gravity = 0;
    this.gravitySpeed = 0;
    this.update = function() {
        ctx = myGameArea.context;
        if (this.type == "text") {
            ctx.font = this.width + " " + this.height;
            ctx.fillStyle = color;
            ctx.fillText(this.text, this.x, this.y);
        } else {
            ctx.fillStyle = color;
            ctx.fillRect(this.x, this.y, this.width, this.height);
        }
    }
    this.newPos = function() {
        this.gravitySpeed += this.gravity;
        this.x += this.speedX;
        this.y += this.speedY + this.gravitySpeed;
        this.hitBottom();
		this.hitTop();
    }
    this.hitBottom = function() {
		
        var rockbottom = myGameArea.canvas.height - this.height;
        if (this.y >= rockbottom) {
            this.y = rockbottom;
			return true;
        }
		return false;
    }
	this.hitTop = function() {
        if (this.y <= 0) {
            this.y = 0;
			return true;
        }
		return false;
    }
	this.hitLeft = function() {
        return this.x <= 0;
    }
	this.hitRight = function() {
		var limitederecho = myGameArea.canvas.width - this.width;
		return this.x > limitederecho;
	}
    this.crashWith = function(otherobj) {
        var myleft = this.x;
        var myright = this.x + (this.width);
        var mytop = this.y;
        var mybottom = this.y + (this.height);
        var otherleft = otherobj.x;
        var otherright = otherobj.x + (otherobj.width);
        var othertop = otherobj.y;
        var otherbottom = otherobj.y + (otherobj.height);
        var crash = true;
        if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
            crash = false;
        }
        return crash;
    }
}

function iaMueve() {
	jugador1.y = (pelota.y - pelota.height) - jugador1.height/2;
}

function stopWaiting() {
	clearInterval(invervalID);
	wait = false;
}

//Se ejecuta cada frame
function updateGameArea() {
	if (iabool) {
		iaMueve();
	}
	
	
	//Collisiones
	if (jugador1.crashWith(pelota)) {
		pelota.speedX = 10 + aumentoVel;
		aumentoVel += incrementoVel;
		var centropelota = pelota.y + pelota.height/2;
		var centrojugador = jugador1.y + jugador1.height/2;
		var maxdiff = pelota.height + jugador1.height/2;
		var newvely = (centropelota - centrojugador) / 3;
		pelota.speedY = newvely;
	}
	else if (jugador2.crashWith(pelota)) {
		pelota.speedX = -10 - aumentoVel;
		aumentoVel += incrementoVel;
		var centropelota = pelota.y + pelota.height/2;
		var centrojugador = jugador2.y + jugador2.height/2;
		var maxdiff = pelota.height + jugador2.height/2;
		var newvely = (centropelota - centrojugador) / 3;
		pelota.speedY = newvely;
	}
	
	if (pelota.hitTop()) {
		pelota.speedY = -pelota.speedY;
	}
	else if (pelota.hitBottom()) {
		pelota.speedY = -pelota.speedY;
	}
	
	if (pelota.hitLeft()) { //Punto del jugador 2 (derecho)
		p2++;
		contadorj2.text = "" + p2;
		pelota.x = pelInitPosX;
		pelota.y = pelInitPosY;
		pelota.speedX = -pelInitVelX;
		aumentoVel = 0;
		wait = true;
		invervalID = setInterval(stopWaiting, 5000);
	}
	else if (pelota.hitRight()) { //Punto del jugador 2 (derecho)
		p1++;
		contadorj1.text = "" + p1;
		pelota.x = pelInitPosX;
		pelota.y = pelInitPosY;
		pelota.speedX = pelInitVelX;
		aumentoVel = 0;
		wait = true;
		invervalID = setInterval(stopWaiting, 5000);
	}
	
	myGameArea.clear();
    myGameArea.frameNo += 1;
	jugador1.newPos();
	jugador1.update();
	jugador2.newPos();
	jugador2.update();
	if (!wait) {
		pelota.newPos();
	}
	pelota.update();
	contadorj1.update();
	contadorj2.update();
	centro.update();
	
	//Comprobar victoria
	
	if (p1 >= 11) {
		alert("Ha ganado el jugador 1!");
		location.reload(); 
	}
	else if (p2 >= 11) {
		alert("Ha ganado el jugador 2!");
		location.reload(); 
	}
}

function keyDownHandler(event) {
	var keyUnicode = event.keyCode;                // Get the Unicode value
	var keyChar = String.fromCharCode(keyUnicode);       // Convert the value into a character
	
	switch(keyChar) {
		case '&': //UP
			jugador2.speedY = -10;
			break;
		
		case '(': //DOWN
			jugador2.speedY = 10;
			break;
	}
	
	switch(keyChar) {
		case 'Q': //UP
			jugador1.speedY = -10;
			break;
		
		case 'A': //DOWN
			jugador1.speedY = 10;
			break;
	}
}

function keyUpHandler(event) {
	var keyUnicode = event.keyCode;                // Get the Unicode value
	var keyChar = String.fromCharCode(keyUnicode);       // Convert the value into a character
	//alert(keyChar);
	switch(keyChar) {
		case '&': //UP
			jugador2.speedY = 0;
			break;
		
		case '(': //DOWN
			jugador2.speedY = 0;
			break;
	}
	
	switch(keyChar) {
		case 'Q': //UP
			jugador1.speedY = 0;
			break;
		
		case 'A': //DOWN
			jugador1.speedY = 0;
			break;
	}
	
}

function iaButton() {
	iabool = !iabool;
}

</script>
	<button onclick="iaButton()">Activar IA</button>
</body>
</html>
